{# ai-sdlc-suite/app/ai_code_review/templates/report.html #}
{% extends "base.html" %}

{% block content %}
<div class="space-y-8">

  <!-- Header -->
  <div class="flex items-start justify-between gap-6">
    <div>
      <h1 class="text-3xl font-semibold text-white">Code Review Report</h1>
      <p class="text-slate-300 mt-1">
        Generated for (Auto) â€¢ {{ debug.source | default("zip") | title }}
      </p>
    </div>

    <div class="flex gap-3">
      <a href="/ai-code-review/report/{{ report_id }}/pdf"
         class="inline-flex items-center rounded-xl bg-orange-500 px-4 py-2 text-sm font-semibold text-white hover:bg-orange-400 transition">
        Download PDF
      </a>
      <a href="/ai-code-review/"
         class="inline-flex items-center rounded-xl border border-slate-600 bg-slate-800 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-700 transition">
        New Review
      </a>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
      <div class="text-xs uppercase tracking-wide text-slate-400">Prepared By</div>
      <div class="mt-2 text-lg font-semibold text-white">
        {{ meta.prepared_by | default("Unknown") }}
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
      <div class="text-xs uppercase tracking-wide text-slate-400">Languages</div>
      <div class="mt-2 text-white">
        <div class="font-semibold">{{ report.languages | default("Unknown") }}</div>
        <div class="text-slate-400 text-sm mt-1">Files scanned (text): {{ report.files_scanned | default(0) }}</div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
      <div class="text-xs uppercase tracking-wide text-slate-400">Overall Checklist</div>
      <div class="mt-3">
        {% set ov = report.overall | default("PASS") %}
        {% if ov == "FAIL" %}
          <span class="inline-flex rounded-full bg-red-900/60 px-3 py-1 text-xs font-semibold text-red-200">FAIL</span>
        {% else %}
          <span class="inline-flex rounded-full bg-emerald-900/60 px-3 py-1 text-xs font-semibold text-emerald-200">PASS</span>
        {% endif %}
      </div>
      <div class="mt-3 text-slate-400 text-sm">Report ID: {{ report_id }}</div>
    </div>
  </div>

  <!-- Repo meta strip -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
      <div>
        <div class="text-slate-400 uppercase text-xs tracking-wide">Repository</div>
        <div class="mt-1 text-white break-all">{{ meta.repo_url | default("") }}</div>
      </div>
      <div>
        <div class="text-slate-400 uppercase text-xs tracking-wide">Branch</div>
        <div class="mt-1 text-white">{{ meta.branch | default("") }}</div>
      </div>
      <div>
        <div class="text-slate-400 uppercase text-xs tracking-wide">Repo Type</div>
        <div class="mt-1 text-white">{{ meta.repository_type | default("") }}</div>
      </div>
    </div>
  </div>

  <!-- Findings -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-white">Findings</h2>
      <div class="text-slate-300 text-sm">Total issues: {{ (issues | length) if issues else 0 }}</div>
    </div>

    {% if not issues or (issues|length) == 0 %}
      <div class="mt-6 text-slate-300">No issues found ðŸŽ‰</div>
    {% else %}
      <div class="mt-6 overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="text-slate-300">
            <tr class="border-b border-slate-800">
              <th class="py-3 pr-4">Category</th>
              <th class="py-3 pr-4">Severity</th>
              <th class="py-3 pr-4">Title</th>
              <th class="py-3 pr-4">Location</th>
              <th class="py-3 pr-4">Remediation</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            {% for i in issues %}
              <tr class="border-b border-slate-800 align-top">
                <td class="py-4 pr-4">{{ i.category | default("â€”") }}</td>

                <td class="py-4 pr-4">
                  {% set sev = (i.severity | default("MEDIUM")) %}
                  <span class="inline-flex rounded-full bg-slate-800 px-3 py-1 text-xs font-semibold">
                    {{ sev }}
                  </span>
                </td>

                <td class="py-4 pr-4 font-semibold text-white">
                  {{ i.title | default("â€”") }}
                </td>

                <!-- âœ… LOCATION: uses i.location first, else file_path:line_start -->
                <td class="py-4 pr-4 text-slate-300">
                  {% set loc = i.location | default("") %}
                  {% if not loc %}
                    {% set fp = i.file_path | default("") %}
                    {% set ls = i.line_start | default("") %}
                    {% if fp and ls %}
                      {{ fp }}:{{ ls }}
                    {% elif fp %}
                      {{ fp }}
                    {% else %}
                      â€”
                    {% endif %}
                  {% else %}
                    {{ loc }}
                  {% endif %}
                </td>

                <!-- âœ… REMEDIATION -->
                <td class="py-4 pr-4 text-slate-300">
                  {% if i.remediation and (i.remediation | trim) %}
                    {{ i.remediation }}
                  {% else %}
                    â€”
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <!-- Final Checklist -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
    <h2 class="text-xl font-semibold text-white">Final Checklist</h2>
    <p class="text-slate-400 text-sm mt-1">Pass/Fail summary by category.</p>

    {% set cl = checklist_rows if checklist_rows is defined else checklist %}
    {% if not cl or (cl|length) == 0 %}
      <div class="mt-6 text-slate-300">No checklist data available.</div>
    {% else %}
      <div class="mt-6 overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="text-slate-300">
            <tr class="border-b border-slate-800">
              <th class="py-3 pr-4">Category</th>
              <th class="py-3 pr-4">Check</th>
              <th class="py-3 pr-4">Status</th>
              <th class="py-3 pr-4">Evidence</th>
              <th class="py-3 pr-4">Remediation</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            {% for row in cl %}
              <tr class="border-b border-slate-800 align-top">
                <td class="py-4 pr-4">{{ row.category }}</td>
                <td class="py-4 pr-4 text-white font-semibold">{{ row.check }}</td>
                <td class="py-4 pr-4">
                  {% if row.status == "FAIL" %}
                    <span class="inline-flex rounded-full bg-red-900/60 px-3 py-1 text-xs font-semibold text-red-200">FAIL</span>
                  {% else %}
                    <span class="inline-flex rounded-full bg-emerald-900/60 px-3 py-1 text-xs font-semibold text-emerald-200">PASS</span>
                  {% endif %}
                </td>
                <td class="py-4 pr-4 text-slate-300">{{ row.evidence | default("") }}</td>
                <td class="py-4 pr-4 text-slate-300">{{ row.remediation | default("") }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <!-- Debug -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 shadow-lg">
    <h2 class="text-xl font-semibold text-white">Debug</h2>
    <p class="text-slate-400 text-sm mt-1">Use this to compare ZIP vs Repo runs (file count + top file paths after filtering).</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 text-sm">
      <div class="text-slate-200 space-y-2">
        <div><span class="text-slate-400">Source:</span> {{ debug.source | default("") }}</div>
        <div><span class="text-slate-400">Repo:</span> {{ debug.repo | default("") }}</div>
        <div><span class="text-slate-400">Branch:</span> {{ debug.branch | default("") }}</div>
        <div><span class="text-slate-400">Files after filter:</span> {{ debug.files_after_filter | default("") }}</div>
      </div>

      <div>
        <div class="text-slate-400 uppercase text-xs tracking-wide">Top Files (first 20)</div>
        <div class="mt-2 rounded-xl border border-slate-800 bg-slate-950 p-3 h-44 overflow-auto text-slate-200">
          {% if debug.top_files and (debug.top_files|length) > 0 %}
            <ul class="space-y-1">
              {% for f in debug.top_files %}
                <li class="font-mono text-xs">{{ f }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-slate-500">No debug file list available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
